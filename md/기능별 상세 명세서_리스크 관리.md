# 리스크 관리 상세 명세서 (Kill Switch 포함)
(B안 – KIS OpenAPI 연계 자동매매 시스템)

---

## 1. 기능 개요

리스크 관리 기능은 자동매매 시스템에서  
**과도한 손실·오주문·시스템 장애로부터 자산을 보호**하기 위한 안전장치 역할을 담당한다.

> 리스크 관리의 핵심 목표는  
> **“수익을 극대화하는 것”이 아니라 “파산을 방지하는 것”**이다.

---

## 2. 기능 범위

- 주문 전 사전 리스크 검증
- 장중·일중 리스크 모니터링
- 손절·익절 기준 관리
- 주문 빈도·미체결 관리
- Kill Switch(강제 중단) 제어
- 리스크 이벤트 감사 로그

---

## 3. 하위 기능 식별

| 기능 ID | 기능명 |
|---|---|
| RISK-01 | 사전 리스크 검증 (Pre-Trade) |
| RISK-02 | 사후 리스크 모니터링 (In-Trade) |
| RISK-03 | 손절 / 익절 관리 |
| RISK-04 | 주문 빈도 / 미체결 관리 |
| RISK-05 | Kill Switch 제어 |
| RISK-06 | 리스크 이력 및 감사 |

---

## 4. 기능 상세 명세

---

### RISK-01. 사전 리스크 검증 (Pre-Trade)

#### 1) 설명
신호를 주문으로 변환하기 전에 **계좌·종목·시장·시스템 조건**을 검증한다.

#### 2) 입력(Input)
- Signal (BUY/SELL)
- 계좌 잔고 / 포지션
- 종목 상태
- 리스크 룰 설정

#### 3) 검증 항목
- 종목당 최대 투자금액/비중
- 계좌 총 투자 한도
- 매수 가능 금액
- 거래정지 / 관리종목 / VI 상태
- 권한(매수/매도 허용 여부)

#### 4) 처리(Process)
- 모든 검증 통과 시 `ApprovedOrderIntent` 생성
- 하나라도 실패 시 주문 차단

#### 5) 출력(Output)
- 승인: 주문 의도
- 차단: 차단 사유 코드

---

### RISK-02. 사후 리스크 모니터링 (In-Trade)

#### 1) 설명
장중 실시간으로 **손익·노출·상태**를 감시한다.

#### 2) 감시 항목
- 일중 손익(PnL)
- 미실현 손실
- 포트폴리오 노출
- 계좌 상태

#### 3) 처리
- 임계값 도달 시 경고 이벤트
- 임계값 초과 시 Kill Switch 트리거

#### 4) 출력
- 리스크 상태 갱신
- 알림 이벤트

---

### RISK-03. 손절 / 익절 관리

#### 1) 설명
포지션 단위의 손절·익절 기준을 관리한다.

#### 2) 기준 유형
- 고정 금액
- 비율 기준(%)
- 트레일링 스탑(확장 옵션)

#### 3) 처리
- 기준 도달 시 강제 청산 신호 생성
- 전략 신호보다 우선 적용

#### 4) 출력
- 강제 매도 신호
- 손절/익절 이벤트 로그

---

### RISK-04. 주문 빈도 / 미체결 관리

#### 1) 설명
비정상적 주문 폭주를 방지한다.

#### 2) 검증 항목
- 분당 최대 주문 수
- 동일 종목 연속 주문 간 최소 간격
- 최대 미체결 주문 수

#### 3) 처리
- 초과 시 주문 차단 또는 지연
- 반복 위반 시 Kill Switch 후보로 지정

#### 4) 출력
- 주문 제한 이벤트

---

### RISK-05. Kill Switch 제어

#### 1) 설명
시스템 전반의 거래를 **즉시 중단**하는 최종 안전장치이다.

#### 2) Kill Switch 트리거 조건
- 일중 최대 손실 초과
- 연속 주문 실패
- 시스템 오류(API 장애, 데이터 유실)
- 운영자 수동 활성화

#### 3) 동작
- 신규 주문 즉시 차단
- 기존 미체결 주문 취소
- (설정 시) 포지션 강제 청산

#### 4) 상태
- `OFF` : 정상
- `ARMED` : 조건 감시 중
- `ON` : 거래 중단

#### 5) 해제 조건
- 운영자 수동 해제
- 새로운 거래일 시작
- 재시작 정책 적용

---

### RISK-06. 리스크 이력 및 감사

#### 1) 설명
모든 리스크 판단과 결과를 기록한다.

#### 2) 기록 대상
- 주문 차단
- 손절/익절 발동
- Kill Switch ON/OFF

#### 3) 출력
- 리스크 감사 로그
- 사후 분석 리포트

---

## 5. 데이터 모델 (요약)

### risk_rules
- rule_id (PK)
- account_id
- rule_type
- rule_value
- is_enabled

### risk_state
- account_id (PK)
- daily_pnl
- exposure
- kill_switch_status
- updated_at

### risk_events
- event_id (PK)
- account_id
- event_type
- event_ts
- reason_code
- details_json

---

## 6. 연계 포인트

- 신호 생성: 주문 승인/차단
- 주문 관리(OMS): 주문 전 필수 검증
- 체결/손익 관리: 실시간 손익 입력
- 모니터링/알림: 리스크 이벤트 통지

---

## 7. 설계 원칙

- 리스크는 **전략보다 우선**
- Kill Switch는 **사람보다 빠르게**
- Fail-Safe 설계 (의심되면 중단)
- 모든 결정은 감사 가능해야 함

---
