# MVP 데모 시나리오 (15분)
(B안 – KIS OpenAPI 연계 자동매매 시스템 / 모의투자(PAPER) 기준)

목표: **“실시간 데이터 → 전략/신호 → 리스크 → 주문 → 체결 → 포지션/손익 → 모니터링/알림 → Kill Switch”**
흐름을 15분 안에 한 번에 보여준다.

---

## 0) 데모 준비(사전 체크 – 시작 전 완료)
- [ ] 모의투자 계좌 등록 및 `ACTIVE`
- [ ] 전략 1개 활성화(예: MA 크로스)
- [ ] 종목 1개(또는 2개) 선택: 예) `005930`
- [ ] 리스크 룰 설정(데모용)
  - 종목당 최대 투자금액: 낮게(예: 100,000원)  ※ 손쉽게 차단 유도
  - 일중 최대 손실: 낮게(예: 5,000원)          ※ Kill Switch 유도(선택)
  - 최대 미체결: 1
- [ ] 알림 채널 준비(예: Slack/Email 중 1개)
- [ ] 화면/로그 준비(권장)
  - 콘솔 로그(실시간)
  - DB 조회 화면(또는 간단 API/CLI로 orders/fills/positions 조회)
  - 모니터링 페이지(Health, Metrics)

---

# 타임라인(15분)

## 1) 0:00~2:00 — 시스템 기동 & Health 확인
### 진행
1. 애플리케이션 시작
2. Health Check 화면/엔드포인트 확인

### 데모 포인트
- 구성요소 상태가 한 눈에 보임
  - REST 연결 OK
  - WebSocket 연결 OK
  - 토큰 유효 OK

### 보여줄 것(예시)
- `/health` 또는 대시보드:
  - `KIS_REST=UP`, `KIS_WS=UP`, `TOKEN=VALID`

---

## 2) 2:00~4:00 — 인증(토큰/승인키) 발급 로그 확인
### 진행
1. 토큰(access_token) 캐시/만료시각 확인
2. WS 승인키(approval_key) 확인

### 데모 포인트
- 토큰은 “필요할 때 발급 → 캐시 → 만료 전 갱신”
- 실전/모의 환경 분리(모의 도메인/설정 사용)

### 보여줄 것
- `broker_tokens`(issued_at/expires_at)
- 감사 로그(AUTH 이벤트)

---

## 3) 4:00~6:00 — 실시간 체결가 수신 확인(시장 데이터)
### 진행
1. 종목 구독 시작(체결가)
2. 10~20초간 tick 수신 확인

### 데모 포인트
- WS 끊김 대비 재연결 로직(설명만)
- tick → 내부 표준 이벤트로 변환

### 보여줄 것
- 콘솔: `MarketTick(symbol, price, qty, ts)`
- 메트릭: `ticks/sec`, `tick_latency_ms`

---

## 4) 6:00~8:00 — 전략 실행 → 신호 생성
### 진행
1. 전략 실행 주기(예: 1분) 확인
2. 신호 생성 로그 확인(BUY/SELL/HOLD)
3. 워밍업/TTL/중복 방지 정책 설명

### 데모 포인트
- 신호는 “주문”이 아니라 “의사결정 결과물”
- 신호에 판단 근거(지표 값) 기록

### 보여줄 것
- `signals` 레코드 1건
- `signal_indicators`(MA 값 등)
- HOLD일 경우 사유(reason)

---

## 5) 8:00~10:30 — 리스크 승인 → 주문 생성/전송(OMS/EMS)
### 진행
1. 신호가 BUY로 나오도록 유도(또는 수동으로 신호 생성 트리거)
2. Pre-Trade 리스크 통과 확인
3. 주문 생성(NEW) → 전송(SENT) → 접수(ACCEPTED) 상태 확인

### 데모 포인트
- `idempotency_key`로 중복 주문 방지
- KIS 주문 타입(지정가/시장가)과 `ORD_UNPR` 규칙

### 보여줄 것
- `orders` 레코드 + `order_status_history`
- `broker_order_map`(broker_order_no)

---

## 6) 10:30~12:30 — 체결 반영 → 포지션/손익 갱신
### 진행
1. 체결 이벤트 수신 확인(부분체결이면 더 좋음)
2. 포지션 수량/평단 갱신
3. 미실현/실현 손익 표시

### 데모 포인트
- 체결은 브로커 기준이 절대적
- 포지션/손익은 재현 가능(원장 기반)

### 보여줄 것
- `fills` 1건 이상
- `positions` 갱신( qty / avg_price )
- `portfolio_snapshot` 1건

---

## 7) 12:30~14:00 — 장애/리스크 상황 데모(선택 1개)
아래 중 **한 가지만** 선택해서 보여주면 15분에 딱 맞음

### 옵션 A) 리스크 차단 데모(가장 쉬움)
- 진행: 종목당 최대 투자금액을 낮춰서 “추가 매수 신호”를 차단
- 기대: 주문 미발행 + `risk_events` 사유코드 기록 + WARN 알림(정책)

### 옵션 B) 주문 폭주 방지(미체결 한도)
- 진행: 체결 안 되는 지정가 주문 1건 유지 → 추가 주문 차단
- 기대: `MAX_OPEN_ORDERS` 차단

### 옵션 C) WS 재연결 설명(실제 끊김 유발은 시간상 선택)
- 진행: 네트워크 끊김 가정 → 재연결 후 구독 복구 흐름 설명
- 기대: 모니터링에서 WS DOWN→UP 전이 기록

---

## 8) 14:00~15:00 — Kill Switch ON 데모 + 알림 확인(핵심 피날레)
### 진행(권장: 수동 Kill Switch)
1. 운영자 명령으로 Kill Switch ON
2. 주문 시도(차단 확인)
3. (시간 남으면) OFF 후 정상 재개 설명

### 데모 포인트
- ON 상태에서 신규 주문이 “0건”으로 강제
- 운영 감사 로그/알림이 남음

### 보여줄 것
- `risk_state.kill_switch_status = ON`
- `ops_audit_log`(누가/언제/왜)
- CRIT 알림 수신 화면

---

# 데모 종료 체크리스트(한 장 요약)

- [ ] Health OK(REST/WS/TOKEN)
- [ ] Tick 수신 OK
- [ ] 신호 1건 이상 생성
- [ ] 주문 1건 이상 전송/상태 추적
- [ ] 체결 반영, 포지션/손익 갱신
- [ ] 리스크 차단 또는 Kill Switch ON 시나리오 성공
- [ ] 알림/감사 로그 확인

---

# Q&A 대비 포인트(짧게 답변용)

- “중복 주문은 어떻게 막나요?”  
  → `idempotency_key` + 상태 동기화로 방지
- “WS 끊기면?”  
  → 자동 재연결 + 구독 복구 + 누락 보정(REST)
- “손실이 커지면?”  
  → 일손절/한도 + Kill Switch로 즉시 차단
- “실전 전환은?”  
  → 모의→실전 환경 분리 + 동일 플로우 재검증(소액)

---
