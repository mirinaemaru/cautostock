# 체결 · 포지션 · 손익 관리 상세 명세서
(B안 – KIS OpenAPI 연계 자동매매 시스템)

---

## 1. 기능 개요

본 기능은 증권사로부터 수신된 **체결 정보를 정확히 반영**하여  
**포지션 상태와 손익(PnL)을 계산·관리**하는 역할을 담당한다.

> 체결·포지션·손익 관리가 정확하지 않으면  
> 리스크 관리, 전략 평가, 백테스트 결과 모두 신뢰할 수 없다.

---

## 2. 기능 범위

- 체결 이벤트 수신 및 정합성 검증
- 주문별/종목별 체결 누적 관리
- 포지션 수량·평단 갱신
- 실현/미실현 손익 계산
- 포트폴리오 스냅샷 생성
- 체결·손익 감사 로그 관리

---

## 3. 하위 기능 식별

| 기능 ID | 기능명 |
|---|---|
| EXE-01 | 체결 이벤트 수신 |
| EXE-02 | 체결 누적 및 주문 상태 반영 |
| POS-01 | 포지션 생성/갱신 |
| POS-02 | 평균단가 계산 |
| PNL-01 | 실현 손익 계산 |
| PNL-02 | 미실현 손익 계산 |
| PNL-03 | 포트폴리오 스냅샷 |
| AUD-01 | 체결·손익 감사 |

---

## 4. 기능 상세 명세

---

### EXE-01. 체결 이벤트 수신

#### 1) 설명
KIS로부터 체결 통보를 수신한다.

#### 2) 입력(Input)
- 체결 이벤트(WebSocket)
- 체결 조회 응답(REST)

#### 3) 처리(Process)
- 체결 중복 여부 검증
- 주문 ID 매핑
- 체결 순서 정렬

#### 4) 출력(Output)
- 표준화된 Fill 이벤트

#### 5) 예외(Exception)
- 체결 누락 의심 → 주문 체결 내역 재조회

---

### EXE-02. 체결 누적 및 주문 상태 반영

#### 1) 설명
부분 체결을 누적하고 주문 상태를 갱신한다.

#### 2) 처리
- 체결 수량 누적
- 잔여 수량 계산
- 주문 상태 전이
  - `PART_FILLED`
  - `FILLED`

#### 3) 출력
- 주문 상태 업데이트

---

### POS-01. 포지션 생성 / 갱신

#### 1) 설명
종목별 포지션을 생성하거나 갱신한다.

#### 2) 처리 규칙
- 신규 매수 → 포지션 생성
- 추가 매수 → 수량 증가
- 매도 → 수량 감소
- 전량 매도 → 포지션 제거 또는 0 유지

#### 3) 출력
- 종목별 포지션

---

### POS-02. 평균단가 계산

#### 1) 설명
포지션의 평균 매입 단가를 계산한다.

#### 2) 계산 방식
- 가중 평균 방식
- 매도 시 평균단가 유지

#### 3) 출력
- avg_price

---

### PNL-01. 실현 손익 계산

#### 1) 설명
매도 체결 시 확정 손익을 계산한다.

#### 2) 계산 요소
- 체결가
- 평균단가
- 체결 수량
- 수수료
- 세금

#### 3) 처리
- 실현 손익 누적
- 손익 원장 기록

---

### PNL-02. 미실현 손익 계산

#### 1) 설명
보유 포지션의 평가 손익을 계산한다.

#### 2) 입력
- 현재가
- 평균단가
- 보유 수량

#### 3) 처리
- 실시간 또는 주기적 계산

#### 4) 출력
- 미실현 손익

---

### PNL-03. 포트폴리오 스냅샷

#### 1) 설명
계좌 전체의 자산 상태를 스냅샷으로 생성한다.

#### 2) 포함 항목
- 현금 잔고
- 종목별 평가금액
- 총 자산
- 총 손익

#### 3) 주기
- 장중 주기적
- 장 마감 시 확정

---

### AUD-01. 체결·손익 감사

#### 1) 설명
체결·포지션·손익 변경 이력을 기록한다.

#### 2) 기록 대상
- 체결 반영
- 포지션 변경
- 손익 변경

---

## 5. 데이터 모델 (요약)

### fills
- fill_id (PK)
- order_id
- symbol
- side
- fill_price
- fill_qty
- fee
- tax
- fill_ts

### positions
- account_id
- symbol
- qty
- avg_price
- realized_pnl
- updated_at

### pnl_ledger
- ledger_id
- account_id
- symbol
- event_type (FILL/ADJUST)
- amount
- event_ts

### portfolio_snapshot
- snapshot_id
- account_id
- total_value
- cash
- unrealized_pnl
- realized_pnl
- snapshot_ts

---

## 6. 연계 포인트

- 주문 관리(OMS): 주문 상태 연계
- 리스크 관리: 실시간 손익 제공
- 전략/신호: 평가 기준 제공
- 모니터링: 손익 변동 알림
- 백테스트: 동일 계산 로직 재사용

---

## 7. 설계 원칙

- 체결은 **브로커 기준이 절대적**
- 손익 계산은 **항상 재현 가능**
- 부분 체결 완전 지원
- 실전/백테스트 계산 로직 동일

---
