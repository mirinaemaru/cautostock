# 주문 관리 상세 명세서 (OMS / EMS)
(B안 – KIS OpenAPI 연계 자동매매 시스템)

---

## 1. 기능 개요

주문 관리 기능은 자동매매 시스템에서  
**신호를 실제 증권사 주문으로 변환·전송·추적·정합성 유지**하는 핵심 영역이다.

- **OMS (Order Management System)**  
  주문의 생성·상태관리·정정·취소·중복방지
- **EMS (Execution Management System)**  
  증권사 API 전송·재시도·체결 이벤트 수신

> 이 영역은 **금전적 손실과 직접 연결**되므로  
> 멱등성, 장애 복구, 상태 정합성이 최우선이다.

---

## 2. 기능 범위

- 주문 생성 및 검증
- 주문 타입 매핑(KIS ORD_DVSN)
- 주문 전송 및 재시도
- 주문 상태 추적
- 정정/취소 처리
- 장애/재시작 시 정합성 복구
- 주문 감사 로그

---

## 3. 하위 기능 식별

| 기능 ID | 기능명 |
|---|---|
| OMS-01 | 주문 생성 |
| OMS-02 | 주문 유효성 검증 |
| OMS-03 | 주문 상태 관리 |
| OMS-04 | 주문 정정 |
| OMS-05 | 주문 취소 |
| EMS-01 | 주문 전송 |
| EMS-02 | 주문 재시도 |
| EMS-03 | 체결/상태 이벤트 처리 |
| EMS-04 | 장애 복구 및 동기화 |

---

## 4. 기능 상세 명세

---

### OMS-01. 주문 생성

#### 1) 설명
리스크 검증을 통과한 신호를 **내부 주문 객체(Order)**로 생성한다.

#### 2) 입력(Input)
- ApprovedOrderIntent
- 계좌 ID
- 종목 코드
- 매수/매도 구분
- 주문 타입(시장가/지정가/IOC/FOK 등)

#### 3) 처리(Process)
- 주문 ID 생성
- **idempotency_key 생성**
  - 기준: `account + strategy_version + symbol + signal_ts + side`
- 주문 초기 상태 `NEW`

#### 4) 출력(Output)
- 내부 주문 객체

#### 5) 예외(Exception)
- 동일 idempotency_key 존재 → 기존 주문 반환

---

### OMS-02. 주문 유효성 검증

#### 1) 설명
증권사 전송 전 주문 유효성을 검증한다.

#### 2) 검증 항목
- 수량 > 0
- 호가단위 적합성
- ORD_DVSN ↔ ORD_UNPR 규칙
- 계좌 권한

#### 3) 처리
- 필요 시 가격 보정
- 검증 실패 시 주문 Reject

---

### OMS-03. 주문 상태 관리

#### 1) 설명
주문 생명주기 전반의 상태를 관리한다.

#### 2) 상태 정의
- NEW
- SENT
- ACCEPTED
- PART_FILLED
- FILLED
- CANCELLED
- REJECTED
- ERROR

#### 3) 처리
- 상태 전이 기록
- 상태 변경 이벤트 발행

---

### OMS-04. 주문 정정

#### 1) 설명
미체결 주문에 대해 가격/수량을 변경한다.

#### 2) 입력
- order_id
- 변경 가격/수량

#### 3) 처리
- 정정 가능 여부 확인
- KIS 정정 API 호출
- 정정 이력 기록

#### 4) 출력
- 수정된 주문 상태

---

### OMS-05. 주문 취소

#### 1) 설명
미체결 주문을 취소한다.

#### 2) 입력
- order_id

#### 3) 처리
- 취소 가능 여부 확인
- KIS 취소 API 호출
- 잔여 미체결 수량 정리

---

### EMS-01. 주문 전송

#### 1) 설명
주문을 KIS REST API로 전송한다.

#### 2) 입력
- Order
- access_token
- hashkey (필요 시)

#### 3) 처리
- 헤더 구성(tr_id, 인증 정보)
- 주문 전송
- 브로커 주문번호 수신

#### 4) 출력
- broker_order_no
- 주문 상태 `SENT`

---

### EMS-02. 주문 재시도

#### 1) 설명
일시적 오류 발생 시 안전하게 재시도한다.

#### 2) 재시도 대상
- 네트워크 오류
- 타임아웃

#### 3) 처리
- 지수 백오프
- 재시도 횟수 제한
- **중복 전송 방지(idempotency)**

---

### EMS-03. 체결 / 상태 이벤트 처리

#### 1) 설명
증권사로부터 체결/상태 이벤트를 수신하여 반영한다.

#### 2) 입력
- WebSocket 체결 통보
- REST 주문 조회 결과

#### 3) 처리
- 부분체결 누적
- 주문 상태 업데이트
- 체결 이벤트 발행

---

### EMS-04. 장애 복구 및 동기화

#### 1) 설명
프로세스 재시작 또는 장애 후 주문 정합성을 복구한다.

#### 2) 처리
- 미확정 주문 조회
- 브로커 주문 상태 재조회
- 내부 상태 강제 동기화

---

## 5. 데이터 모델 (요약)

### orders
- order_id (PK)
- idempotency_key (UNIQUE)
- account_id
- strategy_version_id
- symbol
- side
- order_type
- qty
- price
- status
- created_at

### broker_order_map
- order_id (FK)
- broker_order_no
- tr_id
- sent_at

### order_status_history
- history_id
- order_id
- status
- event_ts
- raw_payload

---

## 6. 연계 포인트

- 신호 생성: 주문 생성
- 리스크 관리: 주문 승인/차단
- 체결·손익 관리: 체결 이벤트 전달
- 모니터링: 주문 실패/지연 알림

---

## 7. 설계 원칙

- 주문은 **한 번만** 발행되어야 한다
- 상태는 항상 **브로커 기준**
- 장애 시 **보수적으로 중단**
- 모든 주문은 추적 가능해야 한다

---
