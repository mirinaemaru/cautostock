# 시장 데이터 관리 상세 명세서
(B안 – 한국투자증권 KIS OpenAPI 기준)

---

## 1. 기능 개요

시장 데이터 관리는 자동매매 시스템에서  
**전략 판단·리스크 관리·주문 실행·백테스트**의 입력이 되는  
모든 시세 데이터를 수집·정규화·저장·제공하는 기능이다.

> 이 기능의 정확성과 안정성은  
> 전략 성능과 실거래 결과에 직접적인 영향을 미친다.

---

## 2. 기능 범위

- 실시간 시세 데이터(WebSocket) 수신
- REST 기반 시세 조회
- 분봉/일봉 데이터 생성
- 거래정지·관리종목·VI 상태 반영
- 기업행위(CA) 데이터 관리
- 데이터 품질 검증 및 장애 대응

---

## 3. 하위 기능 식별

| 기능 ID | 기능명 |
|---|---|
| MD-01 | 실시간 시세 수신 (체결가) |
| MD-02 | 실시간 호가 수신 |
| MD-03 | REST 시세 조회 |
| MD-04 | 봉 데이터 생성 |
| MD-05 | 종목 상태 관리 |
| MD-06 | 기업행위 데이터 관리 |
| MD-07 | 데이터 품질 및 장애 대응 |

---

## 4. 기능 상세 명세

---

### MD-01. 실시간 시세 수신 (체결가)

#### 1) 설명
KIS WebSocket을 통해 **실시간 체결가 데이터**를 수신한다.

- TR ID: `H0STCNT0`
- 대상: 전략 실행, 실시간 포지션 평가

#### 2) 입력(Input)
- approval_key
- 종목 코드 목록

#### 3) 처리(Process)
- WebSocket 연결 및 구독
- 체결 이벤트 수신
- 타임스탬프 KST 기준 정규화
- 중복 이벤트 제거
- 내부 표준 `MarketTick` 이벤트로 변환

#### 4) 출력(Output)
- 실시간 체결 이벤트 스트림
- (선택) 원시 체결 데이터 저장

#### 5) 예외(Exception)
- 연결 끊김 → 자동 재연결
- 지연 데이터 → 허용 지연 윈도우 초과 시 폐기 + 경고

---

### MD-02. 실시간 호가 수신

#### 1) 설명
실시간 매수/매도 호가 정보를 수신한다.

- TR ID: `H0STASP0`

#### 2) 처리
- 호가 레벨별 가격/잔량 파싱
- 호가 데이터 최신성 유지(Last Snapshot)
- 전략/리스크 엔진에 이벤트 전달

#### 3) 출력
- `OrderBookSnapshot`

#### 4) 예외
- 호가 데이터 누락 → 마지막 유효 호가 유지

---

### MD-03. REST 시세 조회

#### 1) 설명
REST API를 통해 현재가·분봉·일봉 데이터를 조회한다.

#### 2) 입력
- 종목 코드
- 조회 구간
- 타임프레임 (1분 / 일봉 등)

#### 3) 처리
- API 호출 Rate Limit 관리
- 응답 데이터 정규화
- 내부 캐시 저장

#### 4) 출력
- 시세 응답 DTO
- DB 저장용 시계열 데이터

#### 5) 예외
- 호출 제한 초과 → 큐 대기 또는 지연 처리

---

### MD-04. 봉 데이터 생성 (Bar Aggregation)

#### 1) 설명
틱/체결 데이터를 기반으로 분봉·일봉을 생성한다.

#### 2) 처리
- OHLCV 계산
- 거래 없는 구간 처리(빈 봉)
- 장 종료 시 봉 확정

#### 3) 출력
- 1분봉 / N분봉 / 일봉 데이터

#### 4) 예외
- 체결 데이터 누락 → 봉 생성 보류 또는 보정

---

### MD-05. 종목 상태 관리

#### 1) 설명
종목의 거래 가능 상태를 관리한다.

#### 2) 상태 유형
- 정상
- 거래정지
- 관리종목
- 변동성 완화장치(VI) 발동

#### 3) 처리
- 상태 변경 이벤트 수신
- 전략/주문 차단 여부 결정

#### 4) 출력
- 종목 상태 테이블 갱신

---

### MD-06. 기업행위(Corporate Actions) 관리

#### 1) 설명
액면분할·병합·배당·권리락 정보를 관리한다.

#### 2) 처리
- 원시 데이터와 조정 데이터 분리 관리
- 백테스트용 조정주가 생성

#### 3) 출력
- 기업행위 이력
- 조정 시계열 데이터

---

### MD-07. 데이터 품질 및 장애 대응

#### 1) 검증 항목
- 시간 역전 데이터
- 가격 음수/이상치
- 거래량 비정상 급증

#### 2) 처리
- 이상치 감지 시 격리
- 운영 알림 발송

---

## 5. 데이터 모델 (요약)

### instruments
- symbol (PK)
- market
- is_tradable
- is_halted
- updated_at

### market_ticks
- symbol
- trade_price
- trade_qty
- trade_ts

### market_bars_1m
- symbol
- open
- high
- low
- close
- volume
- bar_ts

### order_books
- symbol
- bid_levels(json)
- ask_levels(json)
- snapshot_ts

### corporate_actions
- symbol
- action_type
- effective_date
- ratio/value

---

## 6. 연계 포인트

- 전략 엔진: 시세 입력
- 리스크 관리: 실시간 평가 손익
- 주문 관리: 거래 가능 여부 판단
- 백테스트: 과거 시계열 제공

---

## 7. 설계 원칙

- 실시간 데이터는 **event-driven**
- REST 데이터는 **cache-first**
- 실전/백테스트 동일 인터페이스 유지
- 데이터 유실보다 **보수적 차단 우선**

---
