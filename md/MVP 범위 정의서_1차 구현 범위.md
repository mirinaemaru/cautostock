# MVP 범위 정의서 (1차 구현 범위)
(B안 – KIS OpenAPI 연계 자동매매 시스템)

---

## 1. 목적

1차(MVP) 목표는 **“실시간 데이터 기반으로 제한된 전략 1개를 안정적으로 자동매매(모의→실전)할 수 있는 최소 기능”**을 구현하는 것이다.

- 수익 극대화보다 **안전성·정합성·관측가능성(모니터링)** 확보가 우선
- KIS 연동 특성(토큰/WS/유량/실전·모의 분리)을 안정적으로 흡수

---

## 2. MVP 원칙

- **단일 계좌 + 단일 전략 + 제한된 종목 수**로 시작
- 주문 타입은 **지정가/시장가** 중심(IOC/FOK/시간외/스톱은 v2)
- 데이터는 **실시간 체결가 중심(호가는 v2)**  
- 장애 시 “보수적 중단(Fail-Safe)” 및 **Kill Switch 필수**
- 모든 이벤트(신호/주문/체결/리스크)는 **감사 로그**로 남김

---

## 3. MVP 포함 기능(필수)

### 3.1 인증 · 계좌 · 권한 관리 (필수)
- KIS REST 토큰(access_token) 발급/캐시/갱신
- WebSocket 승인키(approval_key) 발급
- 계좌 등록(모의/실전 분리)
- 계좌 상태(ACTIVE/INACTIVE/SUSPENDED)
- 권한(자동매매 ON/OFF, 매수/매도 허용)

**완료 기준**
- 토큰 만료 없이 장중 안정 호출
- 모의/실전 절대 혼용 방지

---

### 3.2 시장 데이터 관리 (필수)
- WebSocket 실시간 체결가 구독(종목 N개)
- 최소한의 Bar(1분봉) 생성 또는 “최근 N분 데이터” 구축
- 종목 거래가능 여부(최소 is_tradable / is_halted) 반영(수동 플래그로 시작 가능)

**완료 기준**
- 재연결 포함, 장중 데이터 누락율이 낮고 모니터링 가능

---

### 3.3 전략 관리 (필수 최소)
- 전략 1개 등록/활성화
- 전략 파라미터 저장(버전 1개로 시작, v2에서 버전 고도화)
- 실행 주기(예: 1분) 스케줄링

**완료 기준**
- 설정 변경 후 재시작 없이 반영(또는 재시작 절차 문서화)

---

### 3.4 신호 생성 (필수)
- 신호 유형: BUY / SELL / HOLD
- 지표 1~2개(예: MA 크로스)
- 신호 TTL(예: 60초)
- 중복 신호 제한(동일 종목/동일 방향 최소 간격)

**완료 기준**
- 같은 입력이면 같은 신호(재현성)
- HOLD 사유 로깅

---

### 3.5 리스크 관리 (Kill Switch 포함) (필수)
- Pre-Trade 체크:
  - 종목당 최대 투자금액
  - 계좌 총 투자 한도
  - 일중 최대 손실 한도(일손절)
  - 최대 미체결 주문 수
- Kill Switch:
  - 손실 한도 초과 시 ON(신규 주문 차단)
  - (MVP) “미체결 취소”까지만 필수, “강제 청산”은 옵션

**완료 기준**
- 리스크 차단 사유 코드가 명확히 남고, ON 상태에서 주문이 0건 발행

---

### 3.6 주문 관리 (OMS/EMS) (필수)
- 주문 타입: 지정가(00), 시장가(01)
- `ORD_DVSN ↔ ORD_UNPR` 규칙 적용
- 멱등키(idempotency_key)로 중복 주문 방지
- 주문 상태 추적(NEW/SENT/ACCEPTED/PART_FILLED/FILLED/CANCELLED/REJECTED/ERROR)
- (MVP) 취소 기능은 필수, 정정은 v2 가능

**완료 기준**
- 재시작 후에도 중복 주문 없음
- 주문 상태가 브로커 기준으로 동기화 가능

---

### 3.7 체결 · 포지션 · 손익 관리 (필수)
- 체결 이벤트 수신(실시간 + 누락 보정 REST)
- 포지션 수량/평단 갱신(가중평균)
- 실현/미실현 손익 계산
- 포트폴리오 스냅샷(주기 1분 or 5분)

**완료 기준**
- 부분 체결 포함 정합성 유지
- 주문-체결-포지션 수량이 일치

---

### 3.8 운영 · 모니터링 · 알림 (필수)
- Health Check: REST/WS/토큰 상태
- 핵심 메트릭:
  - 전략 실행 시간
  - 주문 성공/실패
  - 체결 지연
  - 일중 손익
- 알림(WARN/CRIT):
  - 주문 거부/실패 급증
  - WS 재연결 반복
  - Kill Switch ON

**완료 기준**
- 장애를 “사후”가 아니라 “즉시” 인지 가능

---

## 4. MVP 제외 기능(2차 이후)

- 호가 기반 전략/체결 최적화(레벨2)
- IOC/FOK/최유리/최우선/시간외/스톱 주문
- 다계좌/다전략 동시 운용
- 파라미터 스윕/워크포워드 최적화(고급 백테스트)
- 고급 리스크(섹터/상관/VAR), 강제 청산 자동화
- 운영 UI 대시보드(초기에는 로그+간단 API로 대체 가능)

---

## 5. MVP 데이터/저장소 최소 세트

### 필수 테이블
- accounts / broker_tokens / account_permissions
- instruments (최소 필드)
- signals
- orders / order_status_history / broker_order_map
- fills / positions / pnl_ledger / portfolio_snapshot
- risk_state / risk_events
- audit_log / alert_log

---

## 6. MVP 성공 기준(Go/No-Go 체크리스트)

- [ ] 모의투자에서 장중 2시간 이상 무중단 운용
- [ ] 토큰 만료/WS 재연결 자동 복구
- [ ] 중복 주문 0건(멱등성 검증)
- [ ] 체결 누락 보정 로직 동작(REST 재조회)
- [ ] Kill Switch 발동 시 신규 주문 0건
- [ ] 주문·체결·포지션 정합성(수량) 일치
- [ ] 핵심 알림(주문 실패, WS 장애, Kill Switch) 수신 확인

---

## 7. MVP 구현 순서(권장)

1) 인증/토큰 + WS 연결
2) 실시간 체결가 수신 + 저장
3) 전략 1개 + 신호 생성
4) 리스크(Pre-Trade) + Kill Switch
5) 주문 전송(지정가/시장가) + 상태 추적
6) 체결 반영 + 포지션/손익
7) 모니터링/알림 + 장애 복구(동기화)

---
