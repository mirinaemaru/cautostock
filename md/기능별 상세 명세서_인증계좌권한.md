# 인증 · 계좌 · 권한 관리 상세 명세서
(B안 – 한국투자증권 KIS OpenAPI 기준)

---

## 1. 기능 개요

본 기능은 주식 자동매매 시스템에서  
**증권사(KIS) API 접근을 위한 인증**,  
**거래 계좌 관리**,  
**기능 및 거래 권한 제어**를 담당한다.

> 모든 주문·시세·체결 기능의 선행 조건이며,  
> 안정성과 보안이 가장 중요한 영역이다.

---

## 2. 기능 범위

- KIS OpenAPI 인증 토큰 관리
- 실전 / 모의 계좌 분리 관리
- 계좌 상태 및 거래 가능 여부 관리
- 기능·거래 단위 권한 제어
- 인증/계좌 관련 감사 로그

---

## 3. 하위 기능 식별

| 기능 ID | 기능명 |
|---|---|
| AUTH-01 | KIS API 인증 토큰 관리 |
| AUTH-02 | WebSocket 승인키 관리 |
| ACCT-01 | 계좌 등록 및 환경 구분 |
| ACCT-02 | 계좌 상태 및 잔고 관리 |
| AUTHZ-01 | 거래 및 기능 권한 관리 |
| AUD-01 | 인증·계좌 감사 로그 |

---

## 4. 기능 상세 명세

---

### AUTH-01. KIS API 인증 토큰 관리

#### 1) 설명
KIS REST API 호출을 위한 `access_token`을 발급·저장·갱신한다.

#### 2) 입력(Input)
- appkey
- appsecret
- 환경 구분 (`is_paper`: 모의/실전)

#### 3) 처리(Process)
- `/oauth2/tokenP` API 호출
- 토큰 발급 결과 캐시
- 만료 시각 관리 (`expires_at`)
- 토큰 만료 전 선제 갱신
- **6시간 이내 재호출 시 기존 토큰 재사용 정책 반영**

#### 4) 출력(Output)
- access_token
- expires_at
- token_status (`VALID | EXPIRED | ERROR`)

#### 5) 예외(Exception)
- 인증 실패 → 거래 전체 차단
- 토큰 만료 상태 주문 요청 → 즉시 재발급 시도 후 재처리
- 잦은 발급 요청 → 내부 Rate Limit 적용

---

### AUTH-02. WebSocket 승인키 관리

#### 1) 설명
실시간 시세/체결 WebSocket 접속을 위한 `approval_key` 관리

#### 2) 입력
- appkey
- appsecret

#### 3) 처리
- `/oauth2/Approval` API 호출
- 세션당 승인키 1개 유지
- 연결 종료 시 재발급

#### 4) 출력
- approval_key

#### 5) 예외
- WebSocket 연결 실패 → 승인키 재발급 후 재연결

---

### ACCT-01. 계좌 등록 및 환경 구분

#### 1) 설명
자동매매에 사용할 증권 계좌를 등록한다.

#### 2) 입력
- broker (`KIS`)
- account_no
- account_product_code
- is_paper (모의/실전)

#### 3) 처리
- 계좌 중복 등록 방지
- 환경별 계좌 분리 저장
- 계좌 초기 상태 `INACTIVE`

#### 4) 출력
- account_id
- account_status

#### 5) 예외
- 이미 등록된 계좌 → Reject
- 환경 혼용(모의/실전) → Reject

---

### ACCT-02. 계좌 상태 및 잔고 관리

#### 1) 설명
계좌의 거래 가능 상태 및 잔고 정보를 관리한다.

#### 2) 입력
- account_id

#### 3) 처리
- 계좌 상태 관리
  - `ACTIVE`
  - `INACTIVE`
  - `SUSPENDED`
- 주기적 잔고 조회
- 매수 가능 금액 계산

#### 4) 출력
- 현금 잔고
- 매수 가능 금액
- 보유 종목 수량

#### 5) 예외
- 잔고 조회 실패 → 마지막 스냅샷 유지 + 경고
- 계좌 정지 상태 → 주문 차단

---

### AUTHZ-01. 거래 및 기능 권한 관리

#### 1) 설명
계좌 단위로 **허용된 기능과 거래 범위**를 제어한다.

#### 2) 권한 유형

| 권한 코드 | 설명 |
|---|---|
| TRADE_BUY | 매수 가능 |
| TRADE_SELL | 매도 가능 |
| AUTO_TRADE | 자동매매 허용 |
| MANUAL_TRADE | 수동주문 허용 |
| BACKTEST | 백테스트 실행 |
| PAPER_ONLY | 모의투자 전용 |

#### 3) 처리
- 주문 생성 전 권한 검증
- 전략 실행 전 권한 검증

#### 4) 예외
- 권한 없는 주문 → 즉시 Reject + 감사 로그

---

### AUD-01. 인증·계좌 감사 로그

#### 1) 설명
인증·계좌·권한 관련 모든 주요 이벤트를 기록한다.

#### 2) 기록 대상
- 토큰 발급/갱신
- 계좌 등록/상태 변경
- 권한 변경
- 인증 실패

#### 3) 출력
- append-only 감사 로그

---

## 5. 데이터 모델 (요약)

### accounts
- account_id (PK)
- broker
- account_no
- account_product_code
- is_paper
- status
- created_at

### broker_tokens
- broker
- is_paper
- access_token (암호화)
- expires_at
- last_refresh_at

### account_permissions
- account_id
- permission_code
- is_enabled

### audit_log
- audit_id
- event_type
- actor
- event_ts
- details_json

---

## 6. 연계 포인트

- 주문관리(OMS): 주문 생성 전 계좌/권한 검증
- 리스크관리: 계좌 상태·잔고 기반 제한
- 모니터링: 인증 실패/계좌 정지 알림
- 백테스트: 실계좌와 완전 분리

---

## 7. 설계 원칙 (중요)

- 실전/모의 계좌 **절대 혼용 금지**
- 인증 실패 시 **Fail-Fast**
- 토큰/비밀정보는 **절대 평문 저장 금지**
- 모든 결정은 감사 로그로 추적 가능해야 함

---
