# MVP 구현 시나리오 테스트 케이스
(B안 – KIS OpenAPI 연계 자동매매 시스템)
대상: 정상/장애/리스크 시나리오 기반 E2E + 핵심 단위 테스트

---

## 0. 테스트 전제(공통)

### 환경
- 모의투자(PAPER) 우선, 통과 후 실전(LIVE) 동일 케이스 재검증(수량/금액은 축소)
- 단일 계좌, 단일 전략, 종목 1~3개로 시작

### 공통 완료 기준
- **중복 주문 0건**
- 주문/체결/포지션 수량 정합성 일치
- 모든 주요 이벤트가 감사 로그/알림 로그에 남음

### 공통 관측 포인트(로그/메트릭)
- auth: token 발급/갱신, ws approval_key, ws 연결상태
- md: tick 수신율, 지연(ms), 누락 감지
- sig: 신호 생성 수, HOLD 사유
- risk: 차단 사유 코드, kill_switch 상태
- oms/ems: 주문 상태 전이, 재시도 횟수, idempotency_key
- exe/pnl: fill 누적, 포지션/손익 갱신, 스냅샷 생성
- alert: WARN/CRIT 발송 여부

---

## 1. 정상(정상 흐름) 테스트 케이스

### TC-N-01 토큰 발급 및 REST 호출 성공
- 목적: 인증/토큰 캐시 정상 동작
- 선행조건: appkey/appsecret 설정 완료
- 절차
  1) access_token 발급 요청
  2) 동일 토큰으로 REST 엔드포인트(예: 잔고/조회) 호출
- 기대결과
  - 토큰 저장(`broker_tokens`) 및 만료시각 기록
  - REST 호출 200 응답
  - 감사 로그(AUTH 이벤트) 기록

---

### TC-N-02 WebSocket 연결 및 실시간 체결가 수신
- 목적: ws 승인키/연결/구독 정상 동작
- 절차
  1) approval_key 발급
  2) WS 연결
  3) 종목 1개 구독 후 1분간 수신
- 기대결과
  - 연결 상태 RUNNING
  - tick 이벤트가 지속 수신(수신율 임계치 충족)
  - 지연/역순 이벤트 처리 정책대로 동작(버퍼/정렬 또는 경고)

---

### TC-N-03 전략 실행 → 신호 생성(HOLD 포함) 정상
- 목적: 전략 스케줄/지표/워밍업/HOLD 처리 확인
- 선행조건: 1분봉/최근 N분 데이터 확보
- 절차
  1) 전략 활성화
  2) 워밍업 부족 상태에서 1회 실행
  3) 워밍업 이후 다시 실행
- 기대결과
  - 워밍업 부족 시 HOLD + 사유 기록
  - 이후 BUY/SELL/HOLD 중 하나가 규칙대로 생성
  - `signals`, `signal_indicators` 저장

---

### TC-N-04 Pre-Trade 리스크 통과 → 주문 생성(지정가)
- 목적: 리스크 승인/주문 스키마 검증/호가단위 보정 확인
- 선행조건: 투자 한도 충분, 거래 가능 종목
- 절차
  1) BUY 신호 발생 유도
  2) 리스크 승인(ApprovedOrderIntent)
  3) OMS 주문 생성(ORD_DVSN=00, ORD_UNPR>0)
- 기대결과
  - 주문 생성(NEW) → 전송(SENT)까지 상태 전이
  - 호가단위 보정 시 raw/effective 기록
  - idempotency_key 생성 및 UNIQUE 보장

---

### TC-N-05 주문 전송 → 체결(부분체결 포함) → 포지션/손익 반영
- 목적: 체결 누적, 평균단가, PnL 정합성 확인
- 절차
  1) 주문 1건 발행
  2) 부분체결이 가능한 상황을 유도(수량 크게/유동성 낮게)
  3) 체결 이벤트 수신
- 기대결과
  - `order_status_history`에 PART_FILLED→FILLED 기록(또는 PART_FILLED 유지)
  - `fills` 누적 저장
  - `positions.qty/avg_price` 갱신
  - `pnl_ledger`에 수수료/세금 포함 이벤트 기록(모의는 0 가능)
  - 포트폴리오 스냅샷 생성

---

### TC-N-06 시장가 주문(ORD_DVSN=01, ORD_UNPR=0) 정상
- 목적: ORD_DVSN ↔ ORD_UNPR 규칙 적용 확인
- 절차
  1) 시장가 주문 생성
  2) ORD_UNPR=0으로 전송
- 기대결과
  - 입력검증 통과
  - 전송/체결 정상
  - ORD_UNPR에 값이 들어오면 0으로 보정 또는 Reject(정책대로)

---

### TC-N-07 주문 취소 정상
- 목적: 미체결 취소, 상태 정합성 확인
- 절차
  1) 지정가 주문 발행(체결이 안 되도록 가격 조정)
  2) 취소 요청
- 기대결과
  - CANCELLED 상태 전이
  - 잔여 미체결 0
  - 취소 관련 감사 로그 기록

---

## 2. 장애(복구/정합성) 테스트 케이스

### TC-F-01 REST API 타임아웃 → 재시도 + 중복방지
- 목적: EMS 재시도 정책과 멱등성 확인
- 절차
  1) 주문 전송 시 네트워크 타임아웃 유발(프록시/방화벽/테스트 더블)
  2) EMS 재시도 수행
- 기대결과
  - 재시도 횟수 제한 내 수행
  - **중복 주문이 발생하지 않음**
  - 최종 실패 시 ERROR/REJECTED 처리 및 CRIT 알림(정책에 따라)

---

### TC-F-02 WebSocket 끊김 → 자동 재연결/재구독
- 목적: WS 회복성 확인
- 절차
  1) WS 연결 중 강제 끊김 유발
  2) 재연결 로직 동작 확인
  3) 재구독 후 tick 수신 재개 확인
- 기대결과
  - 재연결 성공
  - 데이터 공백 구간 감지 및 경고 로그
  - 필요 시 REST로 누락 보정(옵션)

---

### TC-F-03 프로세스 재시작 중 주문 상태 정합성 복구
- 목적: 장애 후 동기화(OMS/EMS-04) 확인
- 절차
  1) 주문 발행 후 상태가 SENT/ACCEPTED인 상태에서 프로세스 종료
  2) 재시작
  3) 미확정 주문 조회 및 브로커 상태 재조회 수행
- 기대결과
  - 내부 주문 상태가 브로커 기준으로 동기화
  - 체결 누락 시 fills 보정 반영
  - idempotency_key로 동일 주문 재발행 없음

---

### TC-F-04 체결 이벤트 누락 → REST 체결조회로 보정
- 목적: Fill 누락 복구 확인
- 절차
  1) WS 체결 이벤트 일부를 드롭(테스트 더블)
  2) 정합성 검사에서 누락 감지
  3) REST 체결조회 실행
- 기대결과
  - 누락 fills 추가 저장
  - 포지션/손익 재계산 후 정합
  - 감사 로그에 “보정 수행” 기록

---

### TC-F-05 DB 일시 장애(쓰기 실패) → Fail-Safe
- 목적: 감사로그/주문/체결 저장 실패 시 정책 확인
- 절차
  1) DB 쓰기 실패 유발(트랜잭션 실패)
  2) 신호/주문 처리 진행 시도
- 기대결과(권장 정책)
  - **거래 중지(Kill Switch 또는 주문 차단)** 우선
  - 재시도/큐 적재(가능하면)
  - CRIT 알림 발송

---

## 3. 리스크(차단/Kill Switch) 테스트 케이스

### TC-R-01 매수 가능 금액 부족 → 주문 차단
- 목적: Pre-Trade 리스크 차단
- 절차
  1) 잔고를 낮게 설정(또는 매수금액 크게)
  2) BUY 신호 발생
- 기대결과
  - 주문 생성 전 차단
  - risk_events에 reason_code 기록
  - 알림(WARN) 발송(정책에 따라)

---

### TC-R-02 종목 거래정지/비거래 상태 → 주문 차단
- 목적: 종목 상태 기반 차단
- 절차
  1) is_halted=true 또는 is_tradable=false로 설정
  2) BUY/SELL 신호 발생
- 기대결과
  - 주문 차단 + 사유 기록
  - 전략은 계속 돌되 해당 종목만 차단(정책)

---

### TC-R-03 종목당 최대 투자금액/비중 초과 → 차단
- 목적: 포지션/노출 제한 확인
- 절차
  1) 특정 종목에 이미 큰 포지션 보유
  2) 추가 BUY 신호 발생
- 기대결과
  - 주문 차단(또는 수량 축소 정책이면 축소)
  - risk_events 기록

---

### TC-R-04 최대 미체결 주문 수 초과 → 차단
- 목적: 주문 폭주 방지
- 절차
  1) 체결 안 되는 지정가 주문을 여러 건 생성
  2) 미체결 개수가 한도 초과
- 기대결과
  - 이후 신규 주문 차단
  - 반복 초과 시 Kill Switch 후보 이벤트 기록

---

### TC-R-05 일중 최대 손실 초과 → Kill Switch ON
- 목적: 손실 한도 기반 Kill Switch 확인
- 절차
  1) (모의) 손실을 누적시키는 시나리오 구성
  2) daily_loss_limit 초과
- 기대결과
  - kill_switch_status=ON
  - 신규 주문이 **전부 차단**
  - CRIT 알림 발송
  - (설정 시) 미체결 주문 일괄 취소 수행

---

### TC-R-06 연속 주문 실패/거부 급증 → Kill Switch ON
- 목적: 시스템 이상 징후 기반 Kill Switch
- 절차
  1) 주문을 의도적으로 계속 실패시키기(잘못된 가격/권한/네트워크 차단)
  2) 연속 실패 횟수 임계치 도달
- 기대결과
  - Kill Switch ON
  - 실패 원인 집계/요약 로그
  - 운영 알림(CRIT)

---

### TC-R-07 운영자 수동 Kill Switch ON/OFF
- 목적: 수동 제어 및 감사 추적
- 절차
  1) 운영자 명령으로 Kill Switch ON
  2) 주문 시도(차단 확인)
  3) 운영자 명령으로 OFF(또는 다음 거래일 자동 OFF 정책)
- 기대결과
  - ON 동안 신규 주문 0건
  - ops_audit_log에 누가/언제/왜 기록
  - OFF 후 정상 재개(필요 시 점검 절차 포함)

---

## 4. 산출물(테스트 결과 기록 템플릿)

### 케이스별 기록 항목
- 케이스 ID / 실행일시 / 환경(PAPER/LIVE)
- 입력 파라미터(전략/종목/수량/가격/리스크 설정)
- 기대결과 / 실제결과
- 로그 링크(주문ID, 신호ID, 체결ID)
- 이슈/개선사항

---

## 5. 최소 통과 기준(Release Gate)

- 정상 TC: N-01~N-07 전부 PASS
- 장애 TC: F-01~F-04 PASS (F-05는 정책에 따라 “거래 중단” 확인)
- 리스크 TC: R-01~R-07 전부 PASS
- 중복 주문 0건, 정합성 오류 0건
- Kill Switch 동작 검증 완료(ON 시 신규 주문 0)
