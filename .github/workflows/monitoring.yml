name: Monitoring - Scheduled Health Checks

on:
  schedule:
    - cron: '*/15 * * * *'  # 15ë¶„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ íŠ¸ë¦¬ê±° í—ˆìš©

jobs:
  health-check:
    name: Health Check
    runs-on: ubuntu-latest

    steps:
      - name: Production Health Check
        id: health_check
        run: |
          HEALTH_URL="${{ secrets.PRODUCTION_HEALTH_URL }}"

          if [ -z "$HEALTH_URL" ]; then
            echo "âš ï¸ PRODUCTION_HEALTH_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 0
          fi

          RESPONSE=$(curl -s -w "\n%{http_code}" "$HEALTH_URL" || echo "000")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"

          if [ "$HTTP_CODE" = "200" ]; then
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "âœ… ì‹œìŠ¤í…œ ì •ìƒ"
          elif [ "$HTTP_CODE" = "503" ]; then
            echo "status=degraded" >> $GITHUB_OUTPUT
            echo "âš ï¸ ì‹œìŠ¤í…œ ì ê²€ ì¤‘"
          else
            echo "status=down" >> $GITHUB_OUTPUT
            echo "âŒ ì‹œìŠ¤í…œ ë‹¤ìš´"
            exit 1
          fi

      - name: Check Kill Switch
        if: always()
        run: |
          KILL_SWITCH_URL="${{ secrets.PRODUCTION_KILL_SWITCH_URL }}"

          if [ -z "$KILL_SWITCH_URL" ]; then
            echo "âš ï¸ PRODUCTION_KILL_SWITCH_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 0
          fi

          RESPONSE=$(curl -s "$KILL_SWITCH_URL" || echo "{}")
          ENABLED=$(echo "$RESPONSE" | grep -o '"enabled":[^,}]*' | cut -d: -f2 | tr -d ' ')

          if [ "$ENABLED" = "true" ]; then
            echo "ğŸ”´ Kill Switch í™œì„±í™”ë¨ - ìë™ ê±°ë˜ ì°¨ë‹¨ ì¤‘"
          elif [ "$ENABLED" = "false" ]; then
            echo "âœ… Kill Switch ë¹„í™œì„±í™” - ì •ìƒ ê±°ë˜ ì¤‘"
          else
            echo "âš ï¸ Kill Switch ìƒíƒœ í™•ì¸ ë¶ˆê°€"
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ - ì•Œë¦¼ì´ í•„ìš”í•©ë‹ˆë‹¤"
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          # ì‹¤ì œ ìš´ì˜ì—ì„œëŠ” ì—¬ê¸°ì— Slack, Email ë“±ì˜ ì•Œë¦¼ ì¶”ê°€

  metrics-check:
    name: Metrics Check
    runs-on: ubuntu-latest

    steps:
      - name: Query Prometheus Metrics
        run: |
          PROMETHEUS_URL="${{ secrets.PROMETHEUS_URL }}"

          if [ -z "$PROMETHEUS_URL" ]; then
            echo "âš ï¸ PROMETHEUS_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 0
          fi

          # JVM ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥  ì²´í¬
          MEMORY_QUERY="jvm_memory_used_bytes{application=\"trading-system\",area=\"heap\"}/jvm_memory_max_bytes{application=\"trading-system\",area=\"heap\"}"
          MEMORY_USAGE=$(curl -s "${PROMETHEUS_URL}/api/v1/query?query=${MEMORY_QUERY}" | grep -o '"value":\[[^]]*\]' || echo "")

          echo "ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ : $MEMORY_USAGE"

          # ì—ëŸ¬ìœ¨ ì²´í¬
          ERROR_QUERY="rate(http_server_requests_seconds_count{application=\"trading-system\",status=~\"5..\"}[5m])"
          ERROR_RATE=$(curl -s "${PROMETHEUS_URL}/api/v1/query?query=${ERROR_QUERY}" | grep -o '"value":\[[^]]*\]' || echo "")

          echo "ì—ëŸ¬ìœ¨ (5ë¶„): $ERROR_RATE"
