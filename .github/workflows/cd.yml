name: CD - Deploy to Production

on:
  push:
    tags:
      - 'v*.*.*'  # v1.0.0, v1.2.3 등의 태그에 대해 배포 실행
  workflow_dispatch:  # 수동 트리거 허용
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  deploy:
    name: Deploy to ${{ github.event.inputs.environment || 'production' }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'corretto'
          cache: 'maven'

      - name: Build with Maven
        run: mvn clean package -DskipTests -B

      - name: Extract version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)" >> $GITHUB_OUTPUT
          fi

      - name: Create deployment package
        run: |
          mkdir -p deploy
          cp target/*.jar deploy/trading-system.jar
          cp -r scripts deploy/
          cp .env.example deploy/.env.example
          tar -czf trading-system-${{ steps.version.outputs.VERSION }}.tar.gz -C deploy .

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: trading-system-${{ steps.version.outputs.VERSION }}.tar.gz
          retention-days: 30

      - name: Deploy to server
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          DEPLOY_DIR: ${{ secrets.DEPLOY_DIR }}
        run: |
          echo "배포 준비: ${{ steps.version.outputs.VERSION }}"
          echo "대상 환경: ${{ github.event.inputs.environment || 'production' }}"

          # SSH 키 설정
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # 배포 패키지 전송
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            trading-system-${{ steps.version.outputs.VERSION }}.tar.gz \
            ${DEPLOY_USER}@${DEPLOY_HOST}:/tmp/

          # 원격 서버에서 배포 실행
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${DEPLOY_USER}@${DEPLOY_HOST} << 'EOF'
            cd ${DEPLOY_DIR}
            tar -xzf /tmp/trading-system-${{ steps.version.outputs.VERSION }}.tar.gz
            ./scripts/deploy.sh prod
          EOF

          # 정리
          rm ~/.ssh/deploy_key

      - name: Health check
        run: |
          echo "배포 후 헬스체크 대기 중..."
          sleep 30

          # 헬스체크 URL (secrets에서 가져오거나 환경 변수로 설정)
          HEALTH_URL="${{ secrets.HEALTH_CHECK_URL }}"

          for i in {1..10}; do
            if curl -f -s "${HEALTH_URL}" > /dev/null; then
              echo "✅ 헬스체크 성공"
              exit 0
            fi
            echo "헬스체크 재시도 중... ($i/10)"
            sleep 10
          done

          echo "❌ 헬스체크 실패"
          exit 1

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: trading-system-${{ steps.version.outputs.VERSION }}.tar.gz
          body: |
            ## Trading System ${{ steps.version.outputs.VERSION }}

            ### 변경사항
            - 자동 배포 완료

            ### 배포 정보
            - 환경: ${{ github.event.inputs.environment || 'production' }}
            - 배포 시간: ${{ github.event.head_commit.timestamp }}
            - 커밋: ${{ github.sha }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify deployment
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" == "success" ]; then
            echo "✅ 배포 성공: ${{ steps.version.outputs.VERSION }}"
          else
            echo "❌ 배포 실패: ${{ steps.version.outputs.VERSION }}"
          fi
